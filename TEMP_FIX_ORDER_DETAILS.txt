Replace lines 79-139 in d:\Bot\bot-telegram-pbs\user\app\api\orders\[orderId]\route.ts

OLD CODE (DELETE):
    // If status is completed but no item_data, try to finalize items now
    if (normalizedDbStatus === 'completed') {
      const hasItemData = itemsPayload.some((item: any) => item.item_data)
      
      if (!hasItemData) {
        console.log('[Order Details] ⚠️ Completed order without item_data, attempting to finalize...')
        try {
          const { data: finalizeResult, error: finalizeError } = await supabase
            .rpc('finalize_items_for_order', {
              p_order_id: orderId,
              p_user_id: 0
            })

          if (!finalizeError && finalizeResult?.ok && finalizeResult.items?.length > 0) {
            console.log(`[Order Details] ✅ Finalized ${finalizeResult.count} items:`, finalizeResult.items)
            
            // Save each finalized item to order_items table
            for (const finalizedItem of finalizeResult.items) {
              const orderItem = (orderData.items || []).find((i: any) => i.product_code === finalizedItem.product_code)
              
              if (!orderItem) {
                console.warn(`[Order Details] No matching order item for product_code: ${finalizedItem.product_code}`)
                continue
              }

              console.log(`[Order Details] Saving item ${finalizedItem.product_code} with data:`, finalizedItem.item_data)
              
              // Delete existing entry first (if any), then insert
              await supabase
                .from('order_items')
                .delete()
                .eq('order_id', orderData.id)
                .eq('product_code', finalizedItem.product_code)

              const { error: insertError } = await supabase
                .from('order_items')
                .insert({
                  order_id: orderData.id,
                  product_id: orderItem.product_id || null,
                  product_code: finalizedItem.product_code,
                  product_name: orderItem.product_name || '',
                  quantity: 1,
                  price: orderItem.price || 0,
                  item_data: finalizedItem.item_data  // CRITICAL: Use item_data from product_items
                })
              
              if (insertError) {
                console.error(`[Order Details] Failed to save item ${finalizedItem.product_code}:`, insertError)
              } else {
                console.log(`[Order Details] ✅ Saved item ${finalizedItem.product_code} to order_items`)
              }
            }

            // Re-fetch order_items after finalization
            const { data: refreshedItems, error: refreshError } = await supabase
              .from('order_items')
              .select('product_code, product_name, quantity, price, item_data')
              .eq('order_id', orderData.id)

            if (refreshError) {
              console.error('[Order Details] Failed to refresh items:', refreshError)
            } else if (refreshedItems && refreshedItems.length > 0) {
              console.log('[Order Details] Refreshed items:', refreshedItems)
              itemsPayload = snapshotItems.map((snap: any) => {
                const fulfilled = refreshedItems.find((fi: any) => fi.product_code === snap.product_code)
                return fulfilled ? { ...snap, ...fulfilled } : snap
              })
            }
          } else {
            console.warn('[Order Details] Finalize failed or no items:', { finalizeError, finalizeResult })
          }
        } catch (finalizeErr: any) {
          console.error('[Order Details] Finalize exception:', finalizeErr)
        }
      }

NEW CODE (REPLACE WITH):
    // If status is completed but no item_data, try to populate from product_items
    if (normalizedDbStatus === 'completed') {
      const hasItemData = itemsPayload.some((item: any) => item.item_data)
      
      if (!hasItemData) {
        console.log('[Order Details] ⚠️ Completed order without item_data in order_items')
        
        try {
          // First, try finalize (for reserved items)
          const { data: finalizeResult, error: finalizeError } = await supabase
            .rpc('finalize_items_for_order', {
              p_order_id: orderId,
              p_user_id: 0
            })

          let itemsToSave: any[] = []

          if (!finalizeError && finalizeResult?.ok && finalizeResult.items?.length > 0) {
            console.log(`[Order Details] ✅ Finalized ${finalizeResult.count} reserved items`)
            itemsToSave = finalizeResult.items
          } else {
            // If finalize fails (items already sold), fetch sold items directly from product_items
            console.log('[Order Details] Items already sold, fetching from product_items...')
            
            const productCodes = (orderData.items || []).map((i: any) => i.product_code)
            
            const { data: soldItems, error: soldError } = await supabase
              .from('product_items')
              .select('id, product_code, item_data')
              .eq('order_id', orderId)
              .eq('status', 'sold')
              .in('product_code', productCodes)

            if (!soldError && soldItems && soldItems.length > 0) {
              console.log(`[Order Details] ✅ Found ${soldItems.length} sold items:`, soldItems)
              itemsToSave = soldItems
            } else {
              console.warn('[Order Details] No sold items found for order')
            }
          }

          // Save items to order_items table
          if (itemsToSave.length > 0) {
            for (const item of itemsToSave) {
              const orderItem = (orderData.items || []).find((i: any) => i.product_code === item.product_code)
              
              if (!orderItem) {
                console.warn(`[Order Details] No matching order item for product_code: ${item.product_code}`)
                continue
              }

              console.log(`[Order Details] Saving item ${item.product_code} with data:`, item.item_data)
              
              // Delete existing entry first (if any), then insert
              await supabase
                .from('order_items')
                .delete()
                .eq('order_id', orderData.id)
                .eq('product_code', item.product_code)

              const { error: insertError } = await supabase
                .from('order_items')
                .insert({
                  order_id: orderData.id,
                  product_id: orderItem.product_id || null,
                  product_code: item.product_code,
                  product_name: orderItem.product_name || '',
                  quantity: 1,
                  price: orderItem.price || 0,
                  item_data: item.item_data  // CRITICAL: Use item_data from product_items
                })
              
              if (insertError) {
                console.error(`[Order Details] Failed to save item ${item.product_code}:`, insertError)
              } else {
                console.log(`[Order Details] ✅ Saved item ${item.product_code} to order_items`)
              }
            }

            // Re-fetch order_items after saving
            const { data: refreshedItems, error: refreshError } = await supabase
              .from('order_items')
              .select('product_code, product_name, quantity, price, item_data')
              .eq('order_id', orderData.id)

            if (refreshError) {
              console.error('[Order Details] Failed to refresh items:', refreshError)
            } else if (refreshedItems && refreshedItems.length > 0) {
              console.log('[Order Details] Refreshed items:', refreshedItems)
              itemsPayload = snapshotItems.map((snap: any) => {
                const fulfilled = refreshedItems.find((fi: any) => fi.product_code === snap.product_code)
                return fulfilled ? { ...snap, ...fulfilled } : snap
              })
            }
          }
        } catch (err: any) {
          console.error('[Order Details] Error populating item_data:', err)
        }
      }
